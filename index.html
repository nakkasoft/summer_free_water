<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>서울시 여름철 무료 생수 제공 위치</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="서울시 각 구에서 운영하는 여름철 무료 생수 제공 위치를 지도에서 확인하세요.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- 로딩 화면 -->
    <div id="loading">
        <div>데이터를 로드하는 중...</div>
        <div id="loadingStatus" style="font-size: 12px; margin-top: 10px; color: #666;"></div>
    </div>

    <!-- 디버그 정보 (개발용) -->
    <div id="debug-info" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; max-width: 300px; display: none;">
        <div id="debug-content"></div>
        <button onclick="document.getElementById('debug-info').style.display='none'" style="margin-top: 5px; padding: 2px 5px;">닫기</button>
    </div>

    <!-- 지도 컨테이너 -->
    <div id="map"></div>
    
    <!-- 컨트롤 패널 -->
    <div id="controls">
        <h3>🚰 생수 제공 위치 찾기</h3>
        
        <div class="control-group">
            <label for="districtFilter">구별 검색</label>
            <select id="districtFilter">
                <option value="">전체 구</option>
                <option value="중구">중구</option>
                <option value="중랑구">중랑구</option>
                <option value="성북구">성북구</option>
                <option value="도봉구">도봉구</option>
                <option value="노원구">노원구</option>
                <option value="마포구">마포구</option>
                <option value="강북구">강북구</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="searchInput">장소명/주소 검색</label>
            <div class="control-row">
                <input type="text" id="searchInput" placeholder="예: 시청, 공원, 도서관">
                <button id="searchBtn">검색</button>
            </div>
        </div>
        
        <div class="control-group">
            <div class="control-row">
                <button id="nearbyBtn">📍 내 주변</button>
                <button id="showAllBtn">🗺️ 전체 보기</button>
            </div>
        </div>
    </div>

    <!-- 통계 정보 -->
    <div id="stats" style="display: none;">
        <span id="totalCount">전체: 0개</span>
        <span id="operatingCount">운영중: 0개</span>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    
    <!-- JavaScript 파일들 -->
    <script src="js/utils/config-loader.js"></script>
    <script src="js/utils/district-manager.js"></script>
    <script src="js/utils/supabase-test.js"></script>
    <script src="js/database/database-interface.js"></script>
    <script src="js/database/local-database.js"></script>
    <script src="js/database/supabase-database.js"></script>
    <script src="js/database/firebase-database.js"></script>
    <script src="js/database/database-factory.js"></script>
    <script src="js/services/water-station-service.js"></script>
    <script src="js/services/error-report-service.js"></script>
    <script src="js/components/error-report-ui.js"></script>
    <script src="js/components/error-report-handler.js"></script>
    <script src="js/components/map-manager.js"></script>
    <script src="js/components/ui-controller.js"></script>
    <script>
        class App {
            constructor() {
                this.configLoader = new ConfigLoader();
                this.waterStationService = null;
                this.mapManager = null;
                this.uiController = null;
            }

            async initialize() {
                try {
                    this.showLoading(true, '앱 초기화 중...');
                    console.log('앱 초기화 시작...');

                    // 설정 로드
                    this.showLoading(true, '설정 로드 중...');
                    console.log('설정 로드 중...');
                    const config = await this.configLoader.loadConfig();
                    console.log('설정 로드 완료:', { hasApiKey: !!config.KAKAO_API_KEY, dbType: config.DATABASE_TYPE });

                    // API 키 검증
                    if (!config.KAKAO_API_KEY) {
                        throw new Error('맵 API 키가 설정되지 않았습니다. 관리자에게 문의 해주세요.');
                    }

                    // 데이터베이스 초기화
                    this.showLoading(true, '데이터베이스 연결 중...');
                    console.log('데이터베이스 초기화 중...');
                    const dbType = this.configLoader.getDatabaseType();
                    const dbConfig = this.configLoader.getDatabaseConfig();
                    const database = DatabaseFactory.create(dbType, dbConfig);
                    
                    this.waterStationService = new WaterStationService(database);
                    const dbInitResult = await this.waterStationService.initialize();
                    
                    if (!dbInitResult) {
                        throw new Error('데이터베이스 초기화에 실패했습니다.');
                    }
                    console.log('데이터베이스 초기화 완료');

                    // 카카오 맵 SDK 로드
                    this.showLoading(true, '카카오맵 SDK 로드 중...');
                    console.log('카카오맵 SDK 로드 중...');
                    await this.loadKakaoMaps(config.KAKAO_API_KEY);
                    console.log('카카오맵 SDK 로드 완료');

                    // 컴포넌트 초기화
                    this.showLoading(true, '지도 및 UI 초기화 중...');
                    console.log('컴포넌트 초기화 중...');
                    
                    // 사용자 위치 가져오기 시도
                    let userLocation = null;
                    try {
                        this.showLoading(true, '위치 정보 확인 중...');
                        userLocation = await this.getUserLocation();
                        console.log('사용자 위치 확인 완료:', userLocation);
                    } catch (error) {
                        console.log('위치 정보 확인 실패, 기본 위치 사용:', error.message);
                    }
                    
                    this.mapManager = new MapManager('map', this.waterStationService, userLocation);
                    this.uiController = new UIController(this.waterStationService, this.mapManager);

                    await this.mapManager.initialize();
                    this.uiController.initialize();
                    console.log('컴포넌트 초기화 완료');

                    // 통계 정보 업데이트
                    this.showLoading(true, '통계 정보 업데이트 중...');
                    await this.updateStats();

                    this.showLoading(false);
                    console.log('앱 초기화 완료');

                } catch (error) {
                    console.error('앱 초기화 실패:', error);
                    this.showLoading(false);
                    
                    // Supabase에 오류 등록
                    await this.logErrorToSupabase(error);
                    
                    // 사용자에게는 간단한 메시지만 표시
                    alert('앱을 초기화하는데 실패했습니다.\n관리자에게 문의해 주세요.');
                    
                    // 디버그 정보는 제거 (상세 정보는 DB에만 저장)
                    console.error('앱 초기화 실패 - 상세 정보는 DB에 저장됨:', error.message);
                }
            }

            async loadKakaoMaps(apiKey) {
                return new Promise(async (resolve, reject) => {
                    try {
                        // API 키 유효성 검증
                        if (!apiKey || apiKey === 'YOUR_ACTUAL_API_KEY_HERE' || apiKey.length < 10) {
                            const error = new Error('유효하지 않은 카카오맵 API 키입니다. config-loader.js에서 API 키를 확인해주세요.');
                            await this.logErrorToSupabase(error);
                            reject(error);
                            return;
                        }

                        // 이미 로드된 경우 처리
                        if (window.kakao && window.kakao.maps) {
                            console.log('카카오맵 SDK가 이미 로드되어 있습니다.');
                            resolve();
                            return;
                        }

                        console.log('카카오맵 SDK 로드 시작...');
                        
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${apiKey}&autoload=false`;
                        
                        // 타임아웃 설정 (10초)
                        const timeout = setTimeout(async () => {
                            const error = new Error('카카오맵 SDK 로드 시간이 초과되었습니다. 네트워크 연결을 확인해주세요.');
                            await this.logErrorToSupabase(error);
                            reject(error);
                        }, 10000);

                        script.onload = function() {
                            clearTimeout(timeout);
                            console.log('카카오맵 SDK 스크립트 로드 완료');
                            
                            // kakao.maps.load로 실제 지도 API 초기화
                            if (window.kakao && window.kakao.maps) {
                                kakao.maps.load(function() {
                                    console.log('카카오맵 API 초기화 완료');
                                    resolve();
                                });
                            } else {
                                const error = new Error('카카오맵 객체를 찾을 수 없습니다.');
                                this.logErrorToSupabase(error);
                                reject(error);
                            }
                        };

                        script.onerror = async (error) => {
                            clearTimeout(timeout);
                            console.error('카카오맵 SDK 스크립트 로드 실패:', error);
                            const mapError = new Error('카카오맵 SDK 스크립트를 로드할 수 없습니다. API 키나 네트워크 연결을 확인해주세요.');
                            await this.logErrorToSupabase(mapError);
                            reject(mapError);
                        };

                        // DOM에 스크립트 추가
                        document.head.appendChild(script);
                    } catch (error) {
                        await this.logErrorToSupabase(error);
                        reject(error);
                    }
                });
            }

            // Supabase에 오류 로그 등록
            async logErrorToSupabase(error) {
                try {
                    // 오류 신고 매니저가 초기화되어 있는지 확인
                    if (window.errorReportManager && typeof window.errorReportManager.submitErrorReport === 'function') {
                        // 상세한 오류 정보 구성
                        let detailedDescription = `앱 초기화 오류: ${error.message}`;
                        
                        // 오류 타입별 상세 정보 추가
                        if (error.message.includes('API 키')) {
                            detailedDescription += '\n해결방법: 카카오맵 API 키 확인 필요';
                        } else if (error.message.includes('네트워크') || error.message.includes('로드')) {
                            detailedDescription += '\n해결방법: 네트워크 연결 또는 방화벽 설정 확인';
                        } else if (error.message.includes('데이터베이스')) {
                            detailedDescription += '\n해결방법: 데이터베이스 연결 또는 JSON 파일 확인';
                        }
                        
                        // 스택 트레이스도 포함
                        if (error.stack) {
                            detailedDescription += `\n스택트레이스: ${error.stack.substring(0, 500)}`;
                        }
                        
                        // 브라우저 정보 추가
                        detailedDescription += `\n브라우저: ${navigator.userAgent}`;
                        detailedDescription += `\n시간: ${new Date().toISOString()}`;
                        
                        const errorData = {
                            stationId: 0, // 시스템 오류는 0으로 설정
                            stationTitle: 'SYSTEM_ERROR',
                            errorType: this.getErrorType(error),
                            description: detailedDescription,
                            contactInfo: ''
                        };
                        
                        await window.errorReportManager.submitErrorReport(errorData);
                        console.log('오류가 Supabase에 등록되었습니다:', error.message);
                    } else {
                        // 오류 신고 매니저가 없으면 로컬에만 저장
                        console.warn('오류 신고 매니저를 사용할 수 없습니다. 로컬에만 저장합니다.');
                        localStorage.setItem(`app_error_${Date.now()}`, JSON.stringify({
                            timestamp: new Date().toISOString(),
                            error: error.message,
                            stack: error.stack,
                            type: this.getErrorType(error),
                            userAgent: navigator.userAgent
                        }));
                    }
                } catch (logError) {
                    console.error('Supabase 오류 등록 실패:', logError);
                    // 최종 백업: 로컬 스토리지에 저장
                    localStorage.setItem(`app_error_fallback_${Date.now()}`, JSON.stringify({
                        timestamp: new Date().toISOString(),
                        originalError: error.message,
                        logError: logError.message,
                        userAgent: navigator.userAgent
                    }));
                }
            }

            // 오류 타입 분류
            getErrorType(error) {
                const message = error.message.toLowerCase();
                
                if (message.includes('api 키') || message.includes('api key')) {
                    return 'API키오류';
                } else if (message.includes('네트워크') || message.includes('network') || message.includes('로드')) {
                    return '네트워크오류';
                } else if (message.includes('데이터베이스') || message.includes('database')) {
                    return '데이터베이스오류';
                } else if (message.includes('카카오맵') || message.includes('kakao')) {
                    return '카카오맵오류';
                } else {
                    return '시스템오류';
                }
            }

            showLoading(show, status = '') {
                const loadingEl = document.getElementById('loading');
                const statusEl = document.getElementById('loadingStatus');
                
                if (loadingEl) {
                    loadingEl.style.display = show ? 'block' : 'none';
                }
                
                if (statusEl && status) {
                    statusEl.textContent = status;
                }
            }

            showDebugInfo(message) {
                const debugEl = document.getElementById('debug-info');
                const contentEl = document.getElementById('debug-content');
                
                if (debugEl && contentEl) {
                    contentEl.innerHTML = message.replace(/\n/g, '<br>');
                    debugEl.style.display = 'block';
                }
            }

            async updateStats() {
                try {
                    const allStations = await this.waterStationService.getAllStations();
                    const operatingCount = allStations.filter(s => s.status === '운영중').length;
                    
                    const totalCountEl = document.getElementById('totalCount');
                    const operatingCountEl = document.getElementById('operatingCount');
                    const statsEl = document.getElementById('stats');
                    
                    if (totalCountEl) totalCountEl.textContent = `전체: ${allStations.length}개`;
                    if (operatingCountEl) operatingCountEl.textContent = `운영중: ${operatingCount}개`;
                    if (statsEl) statsEl.style.display = 'block';
                } catch (error) {
                    console.error('통계 정보 업데이트 실패:', error);
                }
            }

            getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('위치 서비스가 지원되지 않습니다.'));
                        return;
                    }

                    // 5초 타임아웃 설정
                    const timeoutId = setTimeout(() => {
                        reject(new Error('위치 정보 요청 시간이 초과되었습니다.'));
                    }, 5000);

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            clearTimeout(timeoutId);
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            });
                        },
                        (error) => {
                            clearTimeout(timeoutId);
                            let errorMessage = '위치 정보를 가져올 수 없습니다.';
                            
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = '위치 액세스가 거부되었습니다.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = '위치 정보를 사용할 수 없습니다.';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = '위치 정보 요청 시간이 초과되었습니다.';
                                    break;
                            }
                            
                            reject(new Error(errorMessage));
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 4000,
                            maximumAge: 60000 // 1분간 캐시된 위치 사용 가능
                        }
                    );
                });
            }
        }

        // 앱 시작
        document.addEventListener('DOMContentLoaded', () => {
            const app = new App();
            app.initialize();
        });
    </script>
</body>
</html>
