<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ì„œìš¸ì‹œ ì—¬ë¦„ì²  ë¬´ë£Œ ìƒìˆ˜ ì œê³µ ìœ„ì¹˜</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ì„œìš¸ì‹œ ê° êµ¬ì—ì„œ ìš´ì˜í•˜ëŠ” ì—¬ë¦„ì²  ë¬´ë£Œ ìƒìˆ˜ ì œê³µ ìœ„ì¹˜ë¥¼ ì§€ë„ì—ì„œ í™•ì¸í•˜ì„¸ìš”.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading">
        <div>ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
        <div id="loadingStatus" style="font-size: 12px; margin-top: 10px; color: #666;"></div>
    </div>

    <!-- ë””ë²„ê·¸ ì •ë³´ (ê°œë°œìš©) -->
    <div id="debug-info" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; max-width: 300px; display: none;">
        <div id="debug-content"></div>
        <button onclick="document.getElementById('debug-info').style.display='none'" style="margin-top: 5px; padding: 2px 5px;">ë‹«ê¸°</button>
    </div>

    <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
    <div id="map"></div>
    
    <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div id="controls">
        <h3>ğŸš° ìƒìˆ˜ ì œê³µ ìœ„ì¹˜ ì°¾ê¸°</h3>
        
        <div class="control-group">
            <label for="districtFilter">êµ¬ë³„ ê²€ìƒ‰</label>
            <select id="districtFilter">
                <option value="">ì „ì²´ êµ¬</option>
                <option value="ì¤‘êµ¬">ì¤‘êµ¬</option>
                <option value="ì¤‘ë‘êµ¬">ì¤‘ë‘êµ¬</option>
                <option value="ì„±ë¶êµ¬">ì„±ë¶êµ¬</option>
                <option value="ë„ë´‰êµ¬">ë„ë´‰êµ¬</option>
                <option value="ë…¸ì›êµ¬">ë…¸ì›êµ¬</option>
                <option value="ë§ˆí¬êµ¬">ë§ˆí¬êµ¬</option>
                <option value="ê°•ë¶êµ¬">ê°•ë¶êµ¬</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="typeFilter">ì œê³µ ë°©ì‹</label>
            <select id="typeFilter">
                <option value="">ì „ì²´ íƒ€ì…</option>
                <option value="ìƒìˆ˜ì œê³µ">ìƒìˆ˜ì œê³µ</option>
                <option value="ëƒ‰ì¥ê³ ">ëƒ‰ì¥ê³ </option>
                <option value="ëƒ‰ì¥ê³ (ì „í™”ì¸ì¦)">ëƒ‰ì¥ê³ (ì „í™”ì¸ì¦)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="searchInput">ì¥ì†Œëª…/ì£¼ì†Œ ê²€ìƒ‰</label>
            <div class="control-row">
                <input type="text" id="searchInput" placeholder="ì˜ˆ: ì‹œì²­, ê³µì›, ë„ì„œê´€">
                <button id="searchBtn">ê²€ìƒ‰</button>
            </div>
        </div>
        
        <div class="control-group">
            <div class="control-row">
                <button id="nearbyBtn">ğŸ“ ë‚´ ì£¼ë³€</button>
                <button id="showAllBtn">ğŸ—ºï¸ ì „ì²´ ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- í†µê³„ ì •ë³´ -->
    <div id="stats" style="display: none;">
        <span id="totalCount">ì „ì²´: 0ê°œ</span>
        <span id="operatingCount">ìš´ì˜ì¤‘: 0ê°œ</span>
    </div>

    <!-- JavaScript íŒŒì¼ë“¤ -->
    <script src="js/utils/config-loader.js"></script>
    <script src="js/database/database-interface.js"></script>
    <script src="js/database/local-database.js"></script>
    <script src="js/database/supabase-database.js"></script>
    <script src="js/database/firebase-database.js"></script>
    <script src="js/database/database-factory.js"></script>
    <script src="js/services/water-station-service.js"></script>
    <script src="js/components/map-manager.js"></script>
    <script src="js/components/ui-controller.js"></script>
    <script>
        class App {
            constructor() {
                this.configLoader = new ConfigLoader();
                this.waterStationService = null;
                this.mapManager = null;
                this.uiController = null;
            }

            async initialize() {
                try {
                    this.showLoading(true, 'ì•± ì´ˆê¸°í™” ì¤‘...');
                    console.log('ì•± ì´ˆê¸°í™” ì‹œì‘...');

                    // ì„¤ì • ë¡œë“œ
                    this.showLoading(true, 'ì„¤ì • ë¡œë“œ ì¤‘...');
                    console.log('ì„¤ì • ë¡œë“œ ì¤‘...');
                    const config = await this.configLoader.loadConfig();
                    console.log('ì„¤ì • ë¡œë“œ ì™„ë£Œ:', { hasApiKey: !!config.KAKAO_API_KEY, dbType: config.DATABASE_TYPE });

                    // API í‚¤ ê²€ì¦
                    if (!config.KAKAO_API_KEY) {
                        throw new Error('ì¹´ì¹´ì˜¤ë§µ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. js/utils/config-loader.js íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }

                    // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
                    this.showLoading(true, 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘...');
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘...');
                    const dbType = this.configLoader.getDatabaseType();
                    const dbConfig = this.configLoader.getDatabaseConfig();
                    const database = DatabaseFactory.create(dbType, dbConfig);
                    
                    this.waterStationService = new WaterStationService(database);
                    const dbInitResult = await this.waterStationService.initialize();
                    
                    if (!dbInitResult) {
                        throw new Error('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ');

                    // ì¹´ì¹´ì˜¤ ë§µ SDK ë¡œë“œ
                    this.showLoading(true, 'ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì¤‘...');
                    console.log('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì¤‘...');
                    await this.loadKakaoMaps(config.KAKAO_API_KEY);
                    console.log('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì™„ë£Œ');

                    // ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
                    this.showLoading(true, 'ì§€ë„ ë° UI ì´ˆê¸°í™” ì¤‘...');
                    console.log('ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì¤‘...');
                    this.mapManager = new MapManager('map', this.waterStationService);
                    this.uiController = new UIController(this.waterStationService, this.mapManager);

                    await this.mapManager.initialize();
                    this.uiController.initialize();
                    console.log('ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');

                    // í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸
                    this.showLoading(true, 'í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘...');
                    await this.updateStats();

                    this.showLoading(false);
                    console.log('ì•± ì´ˆê¸°í™” ì™„ë£Œ');

                } catch (error) {
                    console.error('ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    this.showLoading(false);
                    
                    // ì‚¬ìš©ìì—ê²Œ ë” êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ
                    let userMessage = 'ì•±ì„ ì´ˆê¸°í™”í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    let debugInfo = `ì—ëŸ¬ ìƒì„¸ ì •ë³´:\n${error.message}\n\n`;
                    
                    if (error.message.includes('API í‚¤')) {
                        userMessage = 'ì¹´ì¹´ì˜¤ë§µ API í‚¤ ë¬¸ì œì…ë‹ˆë‹¤.';
                        debugInfo += 'í•´ê²° ë°©ë²•:\n1. https://developers.kakao.com ì—ì„œ API í‚¤ ë°œê¸‰\n2. js/utils/config-loader.js íŒŒì¼ì—ì„œ API í‚¤ ì„¤ì •';
                    } else if (error.message.includes('ë„¤íŠ¸ì›Œí¬') || error.message.includes('ë¡œë“œ')) {
                        userMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œì…ë‹ˆë‹¤.';
                        debugInfo += 'í•´ê²° ë°©ë²•:\n1. ì¸í„°ë„· ì—°ê²° í™•ì¸\n2. ë°©í™”ë²½ ì„¤ì • í™•ì¸\n3. ë¡œì»¬ ì›¹ì„œë²„ ì‚¬ìš© (CORS ë¬¸ì œ)';
                    } else if (error.message.includes('ë°ì´í„°ë² ì´ìŠ¤')) {
                        userMessage = 'ë°ì´í„° ë¡œë“œ ë¬¸ì œì…ë‹ˆë‹¤.';
                        debugInfo += 'í•´ê²° ë°©ë²•:\n1. data/water_stations.json íŒŒì¼ í™•ì¸\n2. ë¡œì»¬ ì›¹ì„œë²„ ì‚¬ìš© í•„ìš”';
                    }
                    
                    alert(userMessage + '\n\nìì„¸í•œ ì •ë³´ëŠ” ë””ë²„ê·¸ ì°½ì„ í™•ì¸í•˜ì„¸ìš”.');
                    this.showDebugInfo(debugInfo);
                }
            }

            async loadKakaoMaps(apiKey) {
                return new Promise((resolve, reject) => {
                    // API í‚¤ ìœ íš¨ì„± ê²€ì¦
                    if (!apiKey || apiKey === 'YOUR_ACTUAL_API_KEY_HERE' || apiKey.length < 10) {
                        reject(new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ì¹´ì˜¤ë§µ API í‚¤ì…ë‹ˆë‹¤. config-loader.jsì—ì„œ API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'));
                        return;
                    }

                    // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì²˜ë¦¬
                    if (window.kakao && window.kakao.maps) {
                        console.log('ì¹´ì¹´ì˜¤ë§µ SDKê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                        resolve();
                        return;
                    }

                    console.log('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì‹œì‘...');
                    
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${apiKey}&autoload=false`;
                    
                    // íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ)
                    const timeout = setTimeout(() => {
                        reject(new Error('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'));
                    }, 10000);

                    script.onload = function() {
                        clearTimeout(timeout);
                        console.log('ì¹´ì¹´ì˜¤ë§µ SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                        
                        // kakao.maps.loadë¡œ ì‹¤ì œ ì§€ë„ API ì´ˆê¸°í™”
                        if (window.kakao && window.kakao.maps) {
                            kakao.maps.load(function() {
                                console.log('ì¹´ì¹´ì˜¤ë§µ API ì´ˆê¸°í™” ì™„ë£Œ');
                                resolve();
                            });
                        } else {
                            reject(new Error('ì¹´ì¹´ì˜¤ë§µ ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
                        }
                    };

                    script.onerror = function(error) {
                        clearTimeout(timeout);
                        console.error('ì¹´ì¹´ì˜¤ë§µ SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                        reject(new Error('ì¹´ì¹´ì˜¤ë§µ SDK ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'));
                    };

                    // DOMì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
                    document.head.appendChild(script);
                });
            }

            showLoading(show, status = '') {
                const loadingEl = document.getElementById('loading');
                const statusEl = document.getElementById('loadingStatus');
                
                if (loadingEl) {
                    loadingEl.style.display = show ? 'block' : 'none';
                }
                
                if (statusEl && status) {
                    statusEl.textContent = status;
                }
            }

            showDebugInfo(message) {
                const debugEl = document.getElementById('debug-info');
                const contentEl = document.getElementById('debug-content');
                
                if (debugEl && contentEl) {
                    contentEl.innerHTML = message.replace(/\n/g, '<br>');
                    debugEl.style.display = 'block';
                }
            }

            async updateStats() {
                try {
                    const allStations = await this.waterStationService.getAllStations();
                    const operatingCount = allStations.filter(s => s.status === 'ìš´ì˜ì¤‘').length;
                    
                    const totalCountEl = document.getElementById('totalCount');
                    const operatingCountEl = document.getElementById('operatingCount');
                    const statsEl = document.getElementById('stats');
                    
                    if (totalCountEl) totalCountEl.textContent = `ì „ì²´: ${allStations.length}ê°œ`;
                    if (operatingCountEl) operatingCountEl.textContent = `ìš´ì˜ì¤‘: ${operatingCount}ê°œ`;
                    if (statsEl) statsEl.style.display = 'block';
                } catch (error) {
                    console.error('í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                }
            }
        }

        // ì•± ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            const app = new App();
            app.initialize();
        });
    </script>
</body>
</html>
