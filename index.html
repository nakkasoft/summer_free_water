<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>서울시 여름철 무료 생수 제공 위치</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="서울시 각 구에서 운영하는 여름철 무료 생수 제공 위치를 지도에서 확인하세요.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- 로딩 화면 -->
    <div id="loading">
        <div>데이터를 로드하는 중...</div>
        <div id="loadingStatus" style="font-size: 12px; margin-top: 10px; color: #666;"></div>
    </div>

    <!-- 디버그 정보 (개발용) -->
    <div id="debug-info" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; max-width: 300px; display: none;">
        <div id="debug-content"></div>
        <button onclick="document.getElementById('debug-info').style.display='none'" style="margin-top: 5px; padding: 2px 5px;">닫기</button>
    </div>

    <!-- 지도 컨테이너 -->
    <div id="map"></div>
    
    <!-- 컨트롤 패널 -->
    <div id="controls">
        <h3>🚰 생수 제공 위치 찾기</h3>
        
        <div class="control-group">
            <label for="districtFilter">구별 검색</label>
            <select id="districtFilter">
                <option value="">전체 구</option>
                <option value="중구">중구</option>
                <option value="중랑구">중랑구</option>
                <option value="성북구">성북구</option>
                <option value="도봉구">도봉구</option>
                <option value="노원구">노원구</option>
                <option value="마포구">마포구</option>
                <option value="강북구">강북구</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="typeFilter">제공 방식</label>
            <select id="typeFilter">
                <option value="">전체 타입</option>
                <option value="생수제공">생수제공</option>
                <option value="냉장고">냉장고</option>
                <option value="냉장고(전화인증)">냉장고(전화인증)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="searchInput">장소명/주소 검색</label>
            <div class="control-row">
                <input type="text" id="searchInput" placeholder="예: 시청, 공원, 도서관">
                <button id="searchBtn">검색</button>
            </div>
        </div>
        
        <div class="control-group">
            <div class="control-row">
                <button id="nearbyBtn">📍 내 주변</button>
                <button id="showAllBtn">🗺️ 전체 보기</button>
            </div>
        </div>
    </div>

    <!-- 통계 정보 -->
    <div id="stats" style="display: none;">
        <span id="totalCount">전체: 0개</span>
        <span id="operatingCount">운영중: 0개</span>
    </div>

    <!-- JavaScript 파일들 -->
    <script src="js/utils/config-loader.js"></script>
    <script src="js/database/database-interface.js"></script>
    <script src="js/database/local-database.js"></script>
    <script src="js/database/supabase-database.js"></script>
    <script src="js/database/firebase-database.js"></script>
    <script src="js/database/database-factory.js"></script>
    <script src="js/services/water-station-service.js"></script>
    <script src="js/components/map-manager.js"></script>
    <script src="js/components/ui-controller.js"></script>
    <script>
        class App {
            constructor() {
                this.configLoader = new ConfigLoader();
                this.waterStationService = null;
                this.mapManager = null;
                this.uiController = null;
            }

            async initialize() {
                try {
                    this.showLoading(true, '앱 초기화 중...');
                    console.log('앱 초기화 시작...');

                    // 설정 로드
                    this.showLoading(true, '설정 로드 중...');
                    console.log('설정 로드 중...');
                    const config = await this.configLoader.loadConfig();
                    console.log('설정 로드 완료:', { hasApiKey: !!config.KAKAO_API_KEY, dbType: config.DATABASE_TYPE });

                    // API 키 검증
                    if (!config.KAKAO_API_KEY) {
                        throw new Error('카카오맵 API 키가 설정되지 않았습니다. js/utils/config-loader.js 파일을 확인해주세요.');
                    }

                    // 데이터베이스 초기화
                    this.showLoading(true, '데이터베이스 연결 중...');
                    console.log('데이터베이스 초기화 중...');
                    const dbType = this.configLoader.getDatabaseType();
                    const dbConfig = this.configLoader.getDatabaseConfig();
                    const database = DatabaseFactory.create(dbType, dbConfig);
                    
                    this.waterStationService = new WaterStationService(database);
                    const dbInitResult = await this.waterStationService.initialize();
                    
                    if (!dbInitResult) {
                        throw new Error('데이터베이스 초기화에 실패했습니다.');
                    }
                    console.log('데이터베이스 초기화 완료');

                    // 카카오 맵 SDK 로드
                    this.showLoading(true, '카카오맵 SDK 로드 중...');
                    console.log('카카오맵 SDK 로드 중...');
                    await this.loadKakaoMaps(config.KAKAO_API_KEY);
                    console.log('카카오맵 SDK 로드 완료');

                    // 컴포넌트 초기화
                    this.showLoading(true, '지도 및 UI 초기화 중...');
                    console.log('컴포넌트 초기화 중...');
                    this.mapManager = new MapManager('map', this.waterStationService);
                    this.uiController = new UIController(this.waterStationService, this.mapManager);

                    await this.mapManager.initialize();
                    this.uiController.initialize();
                    console.log('컴포넌트 초기화 완료');

                    // 통계 정보 업데이트
                    this.showLoading(true, '통계 정보 업데이트 중...');
                    await this.updateStats();

                    this.showLoading(false);
                    console.log('앱 초기화 완료');

                } catch (error) {
                    console.error('앱 초기화 실패:', error);
                    this.showLoading(false);
                    
                    // 사용자에게 더 구체적인 에러 메시지 제공
                    let userMessage = '앱을 초기화하는데 실패했습니다.';
                    let debugInfo = `에러 상세 정보:\n${error.message}\n\n`;
                    
                    if (error.message.includes('API 키')) {
                        userMessage = '카카오맵 API 키 문제입니다.';
                        debugInfo += '해결 방법:\n1. https://developers.kakao.com 에서 API 키 발급\n2. js/utils/config-loader.js 파일에서 API 키 설정';
                    } else if (error.message.includes('네트워크') || error.message.includes('로드')) {
                        userMessage = '네트워크 연결 문제입니다.';
                        debugInfo += '해결 방법:\n1. 인터넷 연결 확인\n2. 방화벽 설정 확인\n3. 로컬 웹서버 사용 (CORS 문제)';
                    } else if (error.message.includes('데이터베이스')) {
                        userMessage = '데이터 로드 문제입니다.';
                        debugInfo += '해결 방법:\n1. data/water_stations.json 파일 확인\n2. 로컬 웹서버 사용 필요';
                    }
                    
                    alert(userMessage + '\n\n자세한 정보는 디버그 창을 확인하세요.');
                    this.showDebugInfo(debugInfo);
                }
            }

            async loadKakaoMaps(apiKey) {
                return new Promise((resolve, reject) => {
                    // API 키 유효성 검증
                    if (!apiKey || apiKey === 'YOUR_ACTUAL_API_KEY_HERE' || apiKey.length < 10) {
                        reject(new Error('유효하지 않은 카카오맵 API 키입니다. config-loader.js에서 API 키를 확인해주세요.'));
                        return;
                    }

                    // 이미 로드된 경우 처리
                    if (window.kakao && window.kakao.maps) {
                        console.log('카카오맵 SDK가 이미 로드되어 있습니다.');
                        resolve();
                        return;
                    }

                    console.log('카카오맵 SDK 로드 시작...');
                    
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${apiKey}&autoload=false`;
                    
                    // 타임아웃 설정 (10초)
                    const timeout = setTimeout(() => {
                        reject(new Error('카카오맵 SDK 로드 시간이 초과되었습니다. 네트워크 연결을 확인해주세요.'));
                    }, 10000);

                    script.onload = function() {
                        clearTimeout(timeout);
                        console.log('카카오맵 SDK 스크립트 로드 완료');
                        
                        // kakao.maps.load로 실제 지도 API 초기화
                        if (window.kakao && window.kakao.maps) {
                            kakao.maps.load(function() {
                                console.log('카카오맵 API 초기화 완료');
                                resolve();
                            });
                        } else {
                            reject(new Error('카카오맵 객체를 찾을 수 없습니다.'));
                        }
                    };

                    script.onerror = function(error) {
                        clearTimeout(timeout);
                        console.error('카카오맵 SDK 스크립트 로드 실패:', error);
                        reject(new Error('카카오맵 SDK 스크립트를 로드할 수 없습니다. API 키나 네트워크 연결을 확인해주세요.'));
                    };

                    // DOM에 스크립트 추가
                    document.head.appendChild(script);
                });
            }

            showLoading(show, status = '') {
                const loadingEl = document.getElementById('loading');
                const statusEl = document.getElementById('loadingStatus');
                
                if (loadingEl) {
                    loadingEl.style.display = show ? 'block' : 'none';
                }
                
                if (statusEl && status) {
                    statusEl.textContent = status;
                }
            }

            showDebugInfo(message) {
                const debugEl = document.getElementById('debug-info');
                const contentEl = document.getElementById('debug-content');
                
                if (debugEl && contentEl) {
                    contentEl.innerHTML = message.replace(/\n/g, '<br>');
                    debugEl.style.display = 'block';
                }
            }

            async updateStats() {
                try {
                    const allStations = await this.waterStationService.getAllStations();
                    const operatingCount = allStations.filter(s => s.status === '운영중').length;
                    
                    const totalCountEl = document.getElementById('totalCount');
                    const operatingCountEl = document.getElementById('operatingCount');
                    const statsEl = document.getElementById('stats');
                    
                    if (totalCountEl) totalCountEl.textContent = `전체: ${allStations.length}개`;
                    if (operatingCountEl) operatingCountEl.textContent = `운영중: ${operatingCount}개`;
                    if (statsEl) statsEl.style.display = 'block';
                } catch (error) {
                    console.error('통계 정보 업데이트 실패:', error);
                }
            }
        }

        // 앱 시작
        document.addEventListener('DOMContentLoaded', () => {
            const app = new App();
            app.initialize();
        });
    </script>
</body>
</html>
