<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ì„œìš¸ì‹œ ì—¬ë¦„ì²  ë¬´ë£Œ ìƒìˆ˜ ì œê³µ ìœ„ì¹˜</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ì„œìš¸ì‹œ ê° êµ¬ì—ì„œ ìš´ì˜í•˜ëŠ” ì—¬ë¦„ì²  ë¬´ë£Œ ìƒìˆ˜ ì œê³µ ìœ„ì¹˜ë¥¼ ì§€ë„ì—ì„œ í™•ì¸í•˜ì„¸ìš”.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading">
        <div>ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
        <div id="loadingStatus" style="font-size: 12px; margin-top: 10px; color: #666;"></div>
    </div>

    <!-- ë””ë²„ê·¸ ì •ë³´ (ê°œë°œìš©) -->
    <div id="debug-info" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; max-width: 300px; display: none;">
        <div id="debug-content"></div>
        <button onclick="document.getElementById('debug-info').style.display='none'" style="margin-top: 5px; padding: 2px 5px;">ë‹«ê¸°</button>
    </div>

    <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
    <div id="map"></div>
    
    <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div id="controls">
        <h3>ğŸš° ìƒìˆ˜ ì œê³µ ìœ„ì¹˜ ì°¾ê¸°</h3>
        
        <div class="control-group">
            <label for="districtFilter">êµ¬ë³„ ê²€ìƒ‰</label>
            <select id="districtFilter">
                <option value="">ì „ì²´ êµ¬</option>
                <option value="ì¤‘êµ¬">ì¤‘êµ¬</option>
                <option value="ì¤‘ë‘êµ¬">ì¤‘ë‘êµ¬</option>
                <option value="ì„±ë¶êµ¬">ì„±ë¶êµ¬</option>
                <option value="ë„ë´‰êµ¬">ë„ë´‰êµ¬</option>
                <option value="ë…¸ì›êµ¬">ë…¸ì›êµ¬</option>
                <option value="ë§ˆí¬êµ¬">ë§ˆí¬êµ¬</option>
                <option value="ê°•ë¶êµ¬">ê°•ë¶êµ¬</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="searchInput">ì¥ì†Œëª…/ì£¼ì†Œ ê²€ìƒ‰</label>
            <div class="control-row">
                <input type="text" id="searchInput" placeholder="ì˜ˆ: ì‹œì²­, ê³µì›, ë„ì„œê´€">
                <button id="searchBtn">ê²€ìƒ‰</button>
            </div>
        </div>
        
        <div class="control-group">
            <div class="control-row">
                <button id="nearbyBtn">ğŸ“ ë‚´ ì£¼ë³€</button>
                <button id="showAllBtn">ğŸ—ºï¸ ì „ì²´ ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- í†µê³„ ì •ë³´ -->
    <div id="stats" style="display: none;">
        <span id="totalCount">ì „ì²´: 0ê°œ</span>
        <span id="operatingCount">ìš´ì˜ì¤‘: 0ê°œ</span>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    
    <!-- JavaScript íŒŒì¼ë“¤ -->
    <script src="js/utils/config-loader.js"></script>
    <script src="js/utils/district-manager.js"></script>
    <script src="js/utils/supabase-test.js"></script>
    <script src="js/database/database-interface.js"></script>
    <script src="js/database/local-database.js"></script>
    <script src="js/database/supabase-database.js"></script>
    <script src="js/database/firebase-database.js"></script>
    <script src="js/database/database-factory.js"></script>
    <script src="js/services/water-station-service.js"></script>
    <script src="js/services/error-report-service.js"></script>
    <script src="js/components/error-report-ui.js"></script>
    <script src="js/components/error-report-handler.js"></script>
    <script src="js/components/map-manager.js"></script>
    <script src="js/components/ui-controller.js"></script>
    <script>
        class App {
            constructor() {
                this.configLoader = new ConfigLoader();
                this.waterStationService = null;
                this.mapManager = null;
                this.uiController = null;
            }

            async initialize() {
                try {
                    this.showLoading(true, 'ì•± ì´ˆê¸°í™” ì¤‘...');
                    console.log('ì•± ì´ˆê¸°í™” ì‹œì‘...');

                    // ì„¤ì • ë¡œë“œ
                    this.showLoading(true, 'ì„¤ì • ë¡œë“œ ì¤‘...');
                    console.log('ì„¤ì • ë¡œë“œ ì¤‘...');
                    const config = await this.configLoader.loadConfig();
                    console.log('ì„¤ì • ë¡œë“œ ì™„ë£Œ:', { hasApiKey: !!config.KAKAO_API_KEY, dbType: config.DATABASE_TYPE });

                    // API í‚¤ ê²€ì¦
                    if (!config.KAKAO_API_KEY) {
                        throw new Error('ë§µ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜ í•´ì£¼ì„¸ìš”.');
                    }

                    // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
                    this.showLoading(true, 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘...');
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘...');
                    const dbType = this.configLoader.getDatabaseType();
                    const dbConfig = this.configLoader.getDatabaseConfig();
                    const database = DatabaseFactory.create(dbType, dbConfig);
                    
                    this.waterStationService = new WaterStationService(database);
                    const dbInitResult = await this.waterStationService.initialize();
                    
                    if (!dbInitResult) {
                        throw new Error('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ');

                    // ì¹´ì¹´ì˜¤ ë§µ SDK ë¡œë“œ
                    this.showLoading(true, 'ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì¤‘...');
                    console.log('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì¤‘...');
                    await this.loadKakaoMaps(config.KAKAO_API_KEY);
                    console.log('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì™„ë£Œ');

                    // ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
                    this.showLoading(true, 'ì§€ë„ ë° UI ì´ˆê¸°í™” ì¤‘...');
                    console.log('ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì¤‘...');
                    
                    // ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                    let userLocation = null;
                    try {
                        this.showLoading(true, 'ìœ„ì¹˜ ì •ë³´ í™•ì¸ ì¤‘...');
                        userLocation = await this.getUserLocation();
                        console.log('ì‚¬ìš©ì ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ:', userLocation);
                    } catch (error) {
                        console.log('ìœ„ì¹˜ ì •ë³´ í™•ì¸ ì‹¤íŒ¨, ê¸°ë³¸ ìœ„ì¹˜ ì‚¬ìš©:', error.message);
                    }
                    
                    this.mapManager = new MapManager('map', this.waterStationService, userLocation);
                    this.uiController = new UIController(this.waterStationService, this.mapManager);

                    await this.mapManager.initialize();
                    this.uiController.initialize();
                    console.log('ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');

                    // í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸
                    this.showLoading(true, 'í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘...');
                    await this.updateStats();

                    this.showLoading(false);
                    console.log('ì•± ì´ˆê¸°í™” ì™„ë£Œ');

                } catch (error) {
                    console.error('ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    this.showLoading(false);
                    
                    // Supabaseì— ì˜¤ë¥˜ ë“±ë¡
                    await this.logErrorToSupabase(error);
                    
                    // ì‚¬ìš©ìì—ê²ŒëŠ” ê°„ë‹¨í•œ ë©”ì‹œì§€ë§Œ í‘œì‹œ
                    alert('ì•±ì„ ì´ˆê¸°í™”í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.');
                    
                    // ë””ë²„ê·¸ ì •ë³´ëŠ” ì œê±° (ìƒì„¸ ì •ë³´ëŠ” DBì—ë§Œ ì €ì¥)
                    console.error('ì•± ì´ˆê¸°í™” ì‹¤íŒ¨ - ìƒì„¸ ì •ë³´ëŠ” DBì— ì €ì¥ë¨:', error.message);
                }
            }

            async loadKakaoMaps(apiKey) {
                return new Promise(async (resolve, reject) => {
                    try {
                        // API í‚¤ ìœ íš¨ì„± ê²€ì¦
                        if (!apiKey || apiKey === 'YOUR_ACTUAL_API_KEY_HERE' || apiKey.length < 10) {
                            const error = new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ì¹´ì˜¤ë§µ API í‚¤ì…ë‹ˆë‹¤. config-loader.jsì—ì„œ API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                            await this.logErrorToSupabase(error);
                            reject(error);
                            return;
                        }

                        // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì²˜ë¦¬
                        if (window.kakao && window.kakao.maps) {
                            console.log('ì¹´ì¹´ì˜¤ë§µ SDKê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                            resolve();
                            return;
                        }

                        console.log('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì‹œì‘...');
                        
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${apiKey}&autoload=false`;
                        
                        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ)
                        const timeout = setTimeout(async () => {
                            const error = new Error('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                            await this.logErrorToSupabase(error);
                            reject(error);
                        }, 10000);

                        script.onload = function() {
                            clearTimeout(timeout);
                            console.log('ì¹´ì¹´ì˜¤ë§µ SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                            
                            // kakao.maps.loadë¡œ ì‹¤ì œ ì§€ë„ API ì´ˆê¸°í™”
                            if (window.kakao && window.kakao.maps) {
                                kakao.maps.load(function() {
                                    console.log('ì¹´ì¹´ì˜¤ë§µ API ì´ˆê¸°í™” ì™„ë£Œ');
                                    resolve();
                                });
                            } else {
                                const error = new Error('ì¹´ì¹´ì˜¤ë§µ ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                this.logErrorToSupabase(error);
                                reject(error);
                            }
                        };

                        script.onerror = async (error) => {
                            clearTimeout(timeout);
                            console.error('ì¹´ì¹´ì˜¤ë§µ SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                            const mapError = new Error('ì¹´ì¹´ì˜¤ë§µ SDK ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                            await this.logErrorToSupabase(mapError);
                            reject(mapError);
                        };

                        // DOMì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
                        document.head.appendChild(script);
                    } catch (error) {
                        await this.logErrorToSupabase(error);
                        reject(error);
                    }
                });
            }

            // Supabaseì— ì˜¤ë¥˜ ë¡œê·¸ ë“±ë¡
            async logErrorToSupabase(error) {
                try {
                    // ì˜¤ë¥˜ ì‹ ê³  ë§¤ë‹ˆì €ê°€ ì´ˆê¸°í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    if (window.errorReportManager && typeof window.errorReportManager.submitErrorReport === 'function') {
                        // ìƒì„¸í•œ ì˜¤ë¥˜ ì •ë³´ êµ¬ì„±
                        let detailedDescription = `ì•± ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`;
                        
                        // ì˜¤ë¥˜ íƒ€ì…ë³„ ìƒì„¸ ì •ë³´ ì¶”ê°€
                        if (error.message.includes('API í‚¤')) {
                            detailedDescription += '\ní•´ê²°ë°©ë²•: ì¹´ì¹´ì˜¤ë§µ API í‚¤ í™•ì¸ í•„ìš”';
                        } else if (error.message.includes('ë„¤íŠ¸ì›Œí¬') || error.message.includes('ë¡œë“œ')) {
                            detailedDescription += '\ní•´ê²°ë°©ë²•: ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë˜ëŠ” ë°©í™”ë²½ ì„¤ì • í™•ì¸';
                        } else if (error.message.includes('ë°ì´í„°ë² ì´ìŠ¤')) {
                            detailedDescription += '\ní•´ê²°ë°©ë²•: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë˜ëŠ” JSON íŒŒì¼ í™•ì¸';
                        }
                        
                        // ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ë„ í¬í•¨
                        if (error.stack) {
                            detailedDescription += `\nìŠ¤íƒíŠ¸ë ˆì´ìŠ¤: ${error.stack.substring(0, 500)}`;
                        }
                        
                        // ë¸Œë¼ìš°ì € ì •ë³´ ì¶”ê°€
                        detailedDescription += `\në¸Œë¼ìš°ì €: ${navigator.userAgent}`;
                        detailedDescription += `\nì‹œê°„: ${new Date().toISOString()}`;
                        
                        const errorData = {
                            stationId: 0, // ì‹œìŠ¤í…œ ì˜¤ë¥˜ëŠ” 0ìœ¼ë¡œ ì„¤ì •
                            stationTitle: 'SYSTEM_ERROR',
                            errorType: this.getErrorType(error),
                            description: detailedDescription,
                            contactInfo: ''
                        };
                        
                        await window.errorReportManager.submitErrorReport(errorData);
                        console.log('ì˜¤ë¥˜ê°€ Supabaseì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤:', error.message);
                    } else {
                        // ì˜¤ë¥˜ ì‹ ê³  ë§¤ë‹ˆì €ê°€ ì—†ìœ¼ë©´ ë¡œì»¬ì—ë§Œ ì €ì¥
                        console.warn('ì˜¤ë¥˜ ì‹ ê³  ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ì—ë§Œ ì €ì¥í•©ë‹ˆë‹¤.');
                        localStorage.setItem(`app_error_${Date.now()}`, JSON.stringify({
                            timestamp: new Date().toISOString(),
                            error: error.message,
                            stack: error.stack,
                            type: this.getErrorType(error),
                            userAgent: navigator.userAgent
                        }));
                    }
                } catch (logError) {
                    console.error('Supabase ì˜¤ë¥˜ ë“±ë¡ ì‹¤íŒ¨:', logError);
                    // ìµœì¢… ë°±ì—…: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    localStorage.setItem(`app_error_fallback_${Date.now()}`, JSON.stringify({
                        timestamp: new Date().toISOString(),
                        originalError: error.message,
                        logError: logError.message,
                        userAgent: navigator.userAgent
                    }));
                }
            }

            // ì˜¤ë¥˜ íƒ€ì… ë¶„ë¥˜
            getErrorType(error) {
                const message = error.message.toLowerCase();
                
                if (message.includes('api í‚¤') || message.includes('api key')) {
                    return 'APIí‚¤ì˜¤ë¥˜';
                } else if (message.includes('ë„¤íŠ¸ì›Œí¬') || message.includes('network') || message.includes('ë¡œë“œ')) {
                    return 'ë„¤íŠ¸ì›Œí¬ì˜¤ë¥˜';
                } else if (message.includes('ë°ì´í„°ë² ì´ìŠ¤') || message.includes('database')) {
                    return 'ë°ì´í„°ë² ì´ìŠ¤ì˜¤ë¥˜';
                } else if (message.includes('ì¹´ì¹´ì˜¤ë§µ') || message.includes('kakao')) {
                    return 'ì¹´ì¹´ì˜¤ë§µì˜¤ë¥˜';
                } else {
                    return 'ì‹œìŠ¤í…œì˜¤ë¥˜';
                }
            }

            showLoading(show, status = '') {
                const loadingEl = document.getElementById('loading');
                const statusEl = document.getElementById('loadingStatus');
                
                if (loadingEl) {
                    loadingEl.style.display = show ? 'block' : 'none';
                }
                
                if (statusEl && status) {
                    statusEl.textContent = status;
                }
            }

            showDebugInfo(message) {
                const debugEl = document.getElementById('debug-info');
                const contentEl = document.getElementById('debug-content');
                
                if (debugEl && contentEl) {
                    contentEl.innerHTML = message.replace(/\n/g, '<br>');
                    debugEl.style.display = 'block';
                }
            }

            async updateStats() {
                try {
                    const allStations = await this.waterStationService.getAllStations();
                    const operatingCount = allStations.filter(s => s.status === 'ìš´ì˜ì¤‘').length;
                    
                    const totalCountEl = document.getElementById('totalCount');
                    const operatingCountEl = document.getElementById('operatingCount');
                    const statsEl = document.getElementById('stats');
                    
                    if (totalCountEl) totalCountEl.textContent = `ì „ì²´: ${allStations.length}ê°œ`;
                    if (operatingCountEl) operatingCountEl.textContent = `ìš´ì˜ì¤‘: ${operatingCount}ê°œ`;
                    if (statsEl) statsEl.style.display = 'block';
                } catch (error) {
                    console.error('í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                }
            }

            getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('ìœ„ì¹˜ ì„œë¹„ìŠ¤ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'));
                        return;
                    }

                    // 5ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
                    const timeoutId = setTimeout(() => {
                        reject(new Error('ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.'));
                    }, 5000);

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            clearTimeout(timeoutId);
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            });
                        },
                        (error) => {
                            clearTimeout(timeoutId);
                            let errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                            
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = 'ìœ„ì¹˜ ì•¡ì„¸ìŠ¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = 'ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                                    break;
                            }
                            
                            reject(new Error(errorMessage));
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 4000,
                            maximumAge: 60000 // 1ë¶„ê°„ ìºì‹œëœ ìœ„ì¹˜ ì‚¬ìš© ê°€ëŠ¥
                        }
                    );
                });
            }
        }

        // ì•± ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            const app = new App();
            app.initialize();
        });
    </script>
</body>
</html>
