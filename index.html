<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>서울시 여름철 무료 생수 제공 위치</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="서울시 각 구에                    this.updateStats();
                    this.showLoading(false);

                } catch (error) {여름철 무료 생수 제공 위치를 지도에서 확인하세요.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- 로딩 화면 -->
    <div id="loading">
        <div>데이터를 로드하는 중...</div>
        <div id="loadingStatus" style="font-size: 12px; margin-top: 10px; color: #666;"></div>
    </div>

    <!-- 디버그 정보 (개발용) -->
    <div id="debug-info" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; max-width: 300px; display: none;">
        <div id="debug-content"></div>
        <button onclick="document.getElementById('debug-info').style.display='none'" style="margin-top: 5px; padding: 2px 5px;">닫기</button>
    </div>

    <!-- 지도 컨테이너 -->
    <div id="map"></div>
    
    <!-- 컨트롤 패널 -->
    <div id="controls">
        <h3>🚰 생수 제공 위치 찾기</h3>
        
        <div class="control-group">
            <label for="districtFilter">구별 검색</label>
            <select id="districtFilter">
                <option value="">전체 구</option>
                <option value="중구">중구</option>
                <option value="중랑구">중랑구</option>
                <option value="성북구">성북구</option>
                <option value="도봉구">도봉구</option>
                <option value="노원구">노원구</option>
                <option value="마포구">마포구</option>
                <option value="강북구">강북구</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="searchInput">장소명/주소 검색</label>
            <div class="control-row">
                <input type="text" id="searchInput" placeholder="예: 시청, 공원, 도서관">
                <button id="searchBtn">검색</button>
            </div>
        </div>
        
        <div class="control-group">
            <div class="control-row">
                <button id="nearbyBtn">📍 내 주변</button>
                <button id="showAllBtn">🗺️ 전체 보기</button>
            </div>
        </div>
    </div>

    <!-- 통계 정보 -->
    <div id="stats" style="display: none;">
        <span id="totalCount">전체: 0개</span>
        <span id="operatingCount">운영중: 0개</span>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    
    <!-- 전역 Supabase 싱글톤 클라이언트 -->
    <script src="js/utils/supabase-global.js"></script>
    
    <!-- 로컬 개발용 임시 환경변수 설정 (빌드 도구 없이 직접 HTML 열 때) -->
    <script>
        // 빌드 도구(Vite 등) 없이 직접 HTML을 열 때만 사용
        // window.ENV가 없으면 임시 설정
        if (!window.ENV) {
            // Vercel 환경에서는 환경변수가 빌드 시 주입되므로 여기서 확인
            const isVercel = window.location.hostname.includes('vercel.app') || 
                           window.location.hostname.includes('vercel.com');
            
            if (isVercel) {
                // Vercel 환경: 환경변수는 빌드 시 주입되므로 기본값만 설정
                window.ENV = {
                    KAKAO_API_KEY: '932066d1403575d3521925f322ec1d8b',
                    DATABASE_TYPE: 'local', // Vercel에서도 로컬 데이터베이스 사용
                    SUPABASE_URL: 'https://gmmnverhexhwboedtlai.supabase.co',
                    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtbW52ZXJoZXhod2JvZWR0bGFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTYyMDgsImV4cCI6MjA3MTIzMjIwOH0.TecIAycrP1rXJYVuDR7lz9fA0nqUWtz4QGqAPOmSdTg'
                };
                console.log('🌐 Vercel 환경: 환경변수 설정됨');
            } else {
                // 로컬 개발 환경
                window.ENV = {
                    KAKAO_API_KEY: '932066d1403575d3521925f322ec1d8b',
                    SUPABASE_URL: 'https://gmmnverhexhwboedtlai.supabase.co',
                    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtbW52ZXJoZXhod2JvZWR0bGFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTYyMDgsImV4cCI6MjA3MTIzMjIwOH0.TecIAycrP1rXJYVuDR7lz9fA0nqUWtz4QGqAPOmSdTg',
                    DATABASE_TYPE: 'local'  // 로컬에서도 local 데이터베이스 사용
                };
                console.log('🔧 로컬 개발모드: 임시 환경변수 설정됨');
            }
        }
        
        // 디버그 함수들
        window.debugApp = function() {
            console.log('🔍 앱 상태 확인:');
            console.log('- Supabase 라이브러리:', typeof supabase !== 'undefined' ? '✅ 로드됨' : '❌ 없음');
            console.log('- 환경변수:', window.ENV);
            console.log('- Kakao Maps:', typeof kakao !== 'undefined' ? '✅ 로드됨' : '❌ 없음');
        };
        
        window.testWaterStations = async function() {
            try {
                console.log('🔍 물 제공 위치 데이터 테스트:');
                const response = await fetch('/data/water_stations.json');
                const data = await response.json();
                console.log('✅ 데이터 로드 성공:', data.length + '개');
                console.log('📍 첫 번째 위치:', data[0]);
                return data;
            } catch (error) {
                console.error('❌ 데이터 로드 실패:', error);
                return null;
            }
        };
        
        window.testAppInitialization = async function() {
            console.log('� 앱 초기화 단계별 테스트:');
            
            // 1. 환경변수 확인
            console.log('1️⃣ 환경변수:', window.ENV);
            
            // 2. Kakao Maps 확인
            console.log('2️⃣ Kakao Maps:', typeof kakao !== 'undefined' ? '✅ 로드됨' : '❌ 없음');
            
            // 3. Supabase 확인
            console.log('3️⃣ Supabase:', typeof supabase !== 'undefined' ? '✅ 로드됨' : '❌ 없음');
            
            // 4. 데이터 확인
            const data = await testWaterStations();
            console.log('4️⃣ 데이터:', data ? `✅ ${data.length}개` : '❌ 없음');
            
            // 5. 앱 인스턴스 확인
            console.log('5️⃣ App 인스턴스:', window.app ? '✅ 생성됨' : '❌ 없음');
            
            return {
                env: !!window.ENV,
                kakao: typeof kakao !== 'undefined',
                supabase: typeof supabase !== 'undefined', 
                data: !!data,
                app: !!window.app
            };
        };
        
        console.log('�💡 디버그 도움말:');
        console.log('- debugApp(): 앱 상태 확인');
        console.log('- testWaterStations(): 물 제공 위치 데이터 테스트');
        console.log('- testAppInitialization(): 앱 초기화 단계별 테스트');
    </script>
    
    <!-- JavaScript 파일들 -->
    <script src="js/utils/config-loader.js"></script>
    <script src="js/utils/district-manager.js"></script>
    <script src="js/database/database-interface.js"></script>
    <script src="js/database/local-database.js"></script>
    <script src="js/database/supabase-database.js"></script>
    <script src="js/database/firebase-database.js"></script>
    <script src="js/database/database-factory.js"></script>
    <script src="js/services/water-station-service.js"></script>
    <script src="js/services/error-report-service.js"></script>
    <script src="js/components/error-report-ui.js"></script>
    <script src="js/components/error-report-handler.js"></script>
    <script src="js/components/map-manager.js"></script>
    <script src="js/components/ui-controller.js"></script>
    <script>
        class App {
            constructor() {
                this.configLoader = new ConfigLoader();
                this.waterStationService = null;
                this.mapManager = null;
                this.uiController = null;
            }

            async initialize() {
                try {
                    this.showLoading(true, '앱 초기화 중...');
                    console.log('🚀 앱 초기화 시작...1');

                    // 설정 로드
                    this.showLoading(true, '설정 로드 중...');
                    console.log('⚙️ 설정 로드 중...');
                    const config = await this.configLoader.loadConfig();
                    console.log('✅ 설정 로드 완료:', { hasApiKey: !!config.KAKAO_API_KEY, dbType: config.DATABASE_TYPE });

                    // API 키 검증
                    if (!config.KAKAO_API_KEY) {
                        throw new Error('맵 API 키가 설정되지 않았습니다. 관리자에게 문의 해주세요.');
                    }

                    // 데이터베이스 초기화
                    this.showLoading(true, '데이터베이스 연결 중...');
                    const dbType = this.configLoader.getDatabaseType();
                    const dbConfig = this.configLoader.getDatabaseConfig();
                    
                    const database = DatabaseFactory.create(dbType, dbConfig);
                    this.waterStationService = new WaterStationService(database);
                    
                    const dbInitResult = await this.waterStationService.initialize();
                    if (!dbInitResult) {
                        throw new Error('데이터베이스 초기화에 실패했습니다.');
                    }

                    // 카카오 맵 SDK 로드
                    this.showLoading(true, '카카오맵 SDK 로드 중...');
                    await this.loadKakaoMaps(config.KAKAO_API_KEY);

                    // 컴포넌트 초기화
                    this.showLoading(true, '지도 및 UI 초기화 중...');
                    
                    // 사용자 위치 가져오기 시도
                    let userLocation = null;
                    try {
                        this.showLoading(true, '위치 정보 확인 중...');
                        userLocation = await this.getUserLocation();
                        console.log('✅ 사용자 위치 확인 완료:', userLocation);
                    } catch (error) {
                        console.log('⚠️ 위치 정보 확인 실패, 기본 위치 사용:', error.message);
                    }
                    
                    console.log('🗺️ MapManager 생성 중...');
                    this.mapManager = new MapManager('map', this.waterStationService, userLocation);
                    this.uiController = new UIController(this.waterStationService, this.mapManager);

                    await this.mapManager.initialize();
                    this.uiController.initialize();

                    // 통계 정보 업데이트
                    this.showLoading(true, '통계 정보 업데이트 중...');
                    console.log('📊 통계 정보 업데이트 중...');
                    await this.updateStats();
                    console.log('✅ 통계 정보 업데이트 완료');

                    this.showLoading(false);
                    console.log('🎉 앱 초기화 완료!');

                } catch (error) {
                    console.error('앱 초기화 실패:', error);
                    this.showLoading(false);
                    
                    // Supabase에 오류 등록
                    await this.logErrorToSupabase(error);
                    
                    // 사용자에게는 간단한 메시지만 표시
                    alert('앱을 초기화하는데 실패했습니다.\n관리자에게 문의해 주세요.');
                    
                    // 디버그 정보는 제거 (상세 정보는 DB에만 저장)
                    console.error('앱 초기화 실패 - 상세 정보는 DB에 저장됨:', error.message);
                }
            }

            async loadKakaoMaps(apiKey) {
                return new Promise(async (resolve, reject) => {
                    try {
                        // API 키 유효성 검증
                        if (!apiKey || apiKey === 'YOUR_ACTUAL_API_KEY_HERE' || apiKey.length < 10) {
                            const error = new Error('유효하지 않은 카카오맵 API 키입니다. config-loader.js에서 API 키를 확인해주세요.');
                            await this.logErrorToSupabase(error);
                            reject(error);
                            return;
                        }

                        // 이미 로드된 경우 처리
                        if (window.kakao && window.kakao.maps) {
                            console.log('카카오맵 SDK가 이미 로드되어 있습니다.');
                            resolve();
                            return;
                        }

                        console.log('카카오맵 SDK 로드 시작...');
                        
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${apiKey}&autoload=false`;
                        
                        // 타임아웃 설정 (10초)
                        const timeout = setTimeout(async () => {
                            const error = new Error('카카오맵 SDK 로드 시간이 초과되었습니다. 네트워크 연결을 확인해주세요.');
                            await this.logErrorToSupabase(error);
                            reject(error);
                        }, 10000);

                        script.onload = function() {
                            clearTimeout(timeout);
                            console.log('카카오맵 SDK 스크립트 로드 완료');
                            
                            // kakao.maps.load로 실제 지도 API 초기화
                            if (window.kakao && window.kakao.maps) {
                                kakao.maps.load(function() {
                                    console.log('카카오맵 API 초기화 완료');
                                    resolve();
                                });
                            } else {
                                const error = new Error('카카오맵 객체를 찾을 수 없습니다.');
                                this.logErrorToSupabase(error);
                                reject(error);
                            }
                        };

                        script.onerror = async (error) => {
                            clearTimeout(timeout);
                            console.error('카카오맵 SDK 스크립트 로드 실패:', error);
                            const mapError = new Error('카카오맵 SDK 스크립트를 로드할 수 없습니다. API 키나 네트워크 연결을 확인해주세요.');
                            await this.logErrorToSupabase(mapError);
                            reject(mapError);
                        };

                        // DOM에 스크립트 추가
                        document.head.appendChild(script);
                    } catch (error) {
                        await this.logErrorToSupabase(error);
                        reject(error);
                    }
                });
            }

            // Supabase에 오류 로그 등록
            // 간단한 오류 로깅 (Supabase 중복 연결 방지)
            async logErrorToSupabase(error) {
                try {
                    console.log('📝 시스템 오류 로깅:', error.message);
                    
                    // 간단하게 콘솔과 로컬스토리지에만 기록 (Supabase 중복 연결 방지)
                    const errorData = {
                        timestamp: new Date().toISOString(),
                        message: error.message,
                        stack: error.stack?.substring(0, 200),
                        userAgent: navigator.userAgent.substring(0, 100),
                        type: this.getErrorType(error)
                    };
                    
                    // 로컬스토리지에 간단히 저장
                    localStorage.setItem(`app_error_${Date.now()}`, JSON.stringify(errorData));
                    
                    console.error('시스템 오류 세부사항:', errorData);
                } catch (logError) {
                    console.warn('오류 로깅 실패:', logError);
                }
            }

            // 오류 타입 분류
            getErrorType(error) {
                const message = error.message.toLowerCase();
                
                if (message.includes('api 키') || message.includes('api key')) {
                    return 'API키오류';
                } else if (message.includes('네트워크') || message.includes('network') || message.includes('로드')) {
                    return '네트워크오류';
                } else if (message.includes('데이터베이스') || message.includes('database')) {
                    return '데이터베이스오류';
                } else if (message.includes('카카오맵') || message.includes('kakao')) {
                    return '카카오맵오류';
                } else {
                    return '시스템오류';
                }
            }

            showLoading(show, status = '') {
                const loadingEl = document.getElementById('loading');
                const statusEl = document.getElementById('loadingStatus');
                
                if (loadingEl) {
                    loadingEl.style.display = show ? 'block' : 'none';
                }
                
                if (statusEl && status) {
                    statusEl.textContent = status;
                }
            }

            showDebugInfo(message) {
                const debugEl = document.getElementById('debug-info');
                const contentEl = document.getElementById('debug-content');
                
                if (debugEl && contentEl) {
                    contentEl.innerHTML = message.replace(/\n/g, '<br>');
                    debugEl.style.display = 'block';
                }
            }

            async updateStats() {
                try {
                    const allStations = await this.waterStationService.getAllStations();
                    const operatingCount = allStations.filter(s => s.status === '운영중').length;
                    
                    const totalCountEl = document.getElementById('totalCount');
                    const operatingCountEl = document.getElementById('operatingCount');
                    const statsEl = document.getElementById('stats');
                    
                    if (totalCountEl) totalCountEl.textContent = `전체: ${allStations.length}개`;
                    if (operatingCountEl) operatingCountEl.textContent = `운영중: ${operatingCount}개`;
                    if (statsEl) statsEl.style.display = 'block';
                } catch (error) {
                    console.error('통계 정보 업데이트 실패:', error);
                }
            }

            getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('위치 서비스가 지원되지 않습니다.'));
                        return;
                    }

                    // 5초 타임아웃 설정
                    const timeoutId = setTimeout(() => {
                        reject(new Error('위치 정보 요청 시간이 초과되었습니다.'));
                    }, 5000);

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            clearTimeout(timeoutId);
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            });
                        },
                        (error) => {
                            clearTimeout(timeoutId);
                            let errorMessage = '위치 정보를 가져올 수 없습니다.';
                            
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = '위치 액세스가 거부되었습니다.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = '위치 정보를 사용할 수 없습니다.';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = '위치 정보 요청 시간이 초과되었습니다.';
                                    break;
                            }
                            
                            reject(new Error(errorMessage));
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 4000,
                            maximumAge: 60000 // 1분간 캐시된 위치 사용 가능
                        }
                    );
                });
            }
        }

        // 디버깅 함수들
        window.testDataLoad = async function() {
            console.log('🧪 수동 데이터 로드 테스트 시작...');
            
            try {
                console.log('1️⃣ fetch로 직접 데이터 로드 시도...');
                const response = await fetch('./data/water_stations.json');
                console.log('📡 fetch 응답:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP 오류: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ 직접 로드 성공:', data.length, '개 레코드');
                console.log('🔍 첫 번째 레코드:', data[0]);
                
                return data;
            } catch (error) {
                console.error('❌ 직접 로드 실패:', error);
                return null;
            }
        };
        
        window.testDatabase = async function() {
            console.log('🧪 데이터베이스 테스트 시작...');
            
            if (!window.app || !window.app.waterStationService) {
                console.error('❌ 앱이 초기화되지 않았습니다.');
                return;
            }
            
            try {
                console.log('2️⃣ WaterStationService를 통한 데이터 로드...');
                const stations = await window.app.waterStationService.getAllStations();
                console.log('✅ 서비스 로드 성공:', stations.length, '개 레코드');
                
                if (stations.length > 0) {
                    console.log('🔍 첫 번째 스테이션:', stations[0]);
                } else {
                    console.warn('⚠️ 서비스에서 빈 배열 반환됨');
                }
                
                return stations;
            } catch (error) {
                console.error('❌ 서비스 로드 실패:', error);
                return null;
            }
        };

        // 앱 시작
        document.addEventListener('DOMContentLoaded', () => {
            const app = new App();
            window.app = app; // 전역 참조 추가 (디버깅용)
            app.initialize();
        });
    </script>
</body>
</html>
